{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Stok Sayım Girişi | {{ sayim_emri.ad }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSS Düzeltilene Kadar Geçici Stil */
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        input[type="text"], input[type="number"], button { padding: 10px; margin: 5px 0; display: block; width: 100%; box-sizing: border-box; }
        .info-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; background-color: #f9f9f9; }
        .message.success { color: green; }
        .message.error { color: red; }
        hr { border: 0; border-top: 1px solid #ccc; margin: 20px 0; }
        .flex-container { display: flex; gap: 10px; margin-bottom: 10px; }
        .flex-container > div { flex: 1; }
    </style>
</head>
<body>
    <div class="info-box">
        <h3>Sayım Bilgileri</h3>
        <p>Sayım Emri: <strong>{{ sayim_emri.ad }}</strong> (ID: {{ sayim_emri.pk }})</p>
        <p>Depo Kodu: <strong id="depo_kodu_gizli">{{ depo_kodu }}</strong></p>
        <p>Personel: <strong id="personel_adi_gizli">{{ personel_adi }}</strong></p>
        <a href="{% url 'raporlama_onay' pk=sayim_emri.pk %}">Raporlama ve Onay Ekranına Git</a>
    </div>

    <h2>1. Stok Arama (Barkod/QR veya Kamera)</h2>
    
    <input type="text" id="barkod_input" placeholder="Barkod/QR kodunu okutun veya girin (Enter'a basın)">
    <small style="color: gray;">(Bu alan Seri No olarak önceliklendirilir.)</small>
    
    <div class="flex-container">
        <button id="camera-btn">📷 Kamera ile Çek</button>
        <input type="file" id="image-input" accept="image/*" style="display: none;">
        <button id="select-file-btn">📂 Dosyadan Seç</button>
    </div>
    <div id="ocr_status" class="message"></div>

    <hr>

    <h3>Veya Detaylı Giriş</h3>
    
    <input type="text" id="stok_kod_input" placeholder="Stok Kodu">
    <input type="text" id="parti_no_input" placeholder="Parti No (Opsiyonel)">
    <input type="text" id="renk_input" placeholder="Renk/Varyant (Opsiyonel)">
    <button id="ara-btn">Stok Ara</button>

    <div id="urun_bilgi_alani" style="margin-top: 15px;">
        <p>Ürün: <strong id="urun_bilgi">Stok kodu veya Barkod girin...</strong></p>
        <p>Sistem Stoğu: <strong id="sistem_stok_goster">0.00</strong></p>
        <p>Son Sayım: <strong id="last_sayim_goster">Bilinmiyor</strong></p>
    </div>

    <hr>

    <h2>2. Sayım Girişi</h2>
    
    <input type="number" id="miktar_input" placeholder="Sayım Miktarı (Örn: 1.00)">
    <button id="sayim_kaydet_btn">KAYDET (**ENTER**)</button>
    <p class="message" id="kayit_mesaji"></p>
    <p>Yeni Toplam Sayım: <strong id="yeni_toplam_goster">0.00</strong></p>


<script>
    // --- TEMEL TANIMLAR ---
    const SAYIM_EMRI_ID = "{{ sayim_emri.pk }}";
    const DEPO_KODU = document.getElementById('depo_kodu_gizli').innerText.trim();
    const PERSONEL_ADI = document.getElementById('personel_adi_gizli').innerText.trim();

    // DOM Elementleri
    const barkodInput = document.getElementById('barkod_input');
    const stokKodInput = document.getElementById('stok_kod_input');
    const partiNoInput = document.getElementById('parti_no_input');
    const renkInput = document.getElementById('renk_input');
    const miktarInput = document.getElementById('miktar_input');
    const ocrStatus = document.getElementById('ocr_status');
    
    let currentStokKod = '';
    let currentPartiNo = 'YOK';
    let currentRenk = 'YOK';
    let currentSeriNo = 'YOK';

    // CSRF Token Fonksiyonu (Django POST için kritik)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const CSRF_TOKEN = getCookie('csrftoken');


    // --- HİBRİT ARAMA FONKSİYONU ---
    function akilliStokAra(seriNo, stokKod, partiNo, renk, depoKod, barkodHamVeri = '') {
        document.getElementById('urun_bilgi').innerText = 'Arama yapılıyor...';
        document.getElementById('sistem_stok_goster').innerText = '0.00';
        document.getElementById('last_sayim_goster').innerText = 'Bilinmiyor';

        const params = new URLSearchParams({
            seri_no: seriNo || 'YOK',
            stok_kod: stokKod || 'YOK',
            parti_no: partiNo || 'YOK',
            renk: renk || 'YOK',
            depo_kod: depoKod,
            barkod_ham_veri: barkodHamVeri || 'YOK'
        });

        fetch(`/ajax/akilli-stok-ara/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('urun_bilgi').innerText = data.urun_bilgi;
                document.getElementById('last_sayim_goster').innerText = data.last_sayim;
                
                if (data.found) {
                    currentStokKod = data.stok_kod;
                    currentPartiNo = data.parti_no;
                    currentRenk = data.renk;

                    stokKodInput.value = data.stok_kod;
                    partiNoInput.value = data.parti_no;
                    renkInput.value = data.renk;
                    document.getElementById('sistem_stok_goster').innerText = data.sistem_stok;

                } else if (data.parti_varyantlar.length > 0 || data.renk_varyantlar.length > 0) {
                    currentStokKod = data.stok_kod;
                    currentPartiNo = partiNo;
                    currentRenk = renk;
                    // Hata: Varyant bulundu, tam eşleşme yok.
                } else {
                    currentStokKod = stokKod;
                    currentPartiNo = partiNo;
                    currentRenk = renk;
                }
            })
            .catch(error => {
                document.getElementById('urun_bilgi').innerText = `Arama Hatası: ${error.message}`;
            });
    }

    // --- GEMINI/OCR İŞLEMLERİ ---
    function geminiOku(file) {
        ocrStatus.className = 'message';
        ocrStatus.innerText = '🔍 Resmi analiz ediyoruz (Gemini Vision)...';

        const formData = new FormData();
        formData.append('image', file);
        
        fetch("{% url 'gemini_parti_oku' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                ocrStatus.className = 'message success';
                ocrStatus.innerText = data.message;
                
                // Form alanlarını Gemini'dan gelen verilerle doldur
                barkodInput.value = data.seri_no;
                stokKodInput.value = data.stok_kod;
                partiNoInput.value = data.parti_no;
                renkInput.value = data.renk;

                // 1. Adım: Form alanları doldu. 2. Adım: Arama fonksiyonunu tetikle.
                akilliStokAra(
                    data.seri_no, 
                    data.stok_kod, 
                    data.parti_no, 
                    data.renk, 
                    DEPO_KODU, 
                    data.barkod_ham_veri
                );
            } else {
                ocrStatus.className = 'message error';
                ocrStatus.innerText = `OCR Hatası: ${data.message}`;
            }
        })
        .catch(error => {
            ocrStatus.className = 'message error';
            ocrStatus.innerText = `Kritik Hata: Sunucuya ulaşılamadı. ${error.message}`;
        });
    }

    // --- OLAY DİNLEYİCİLERİ ---

    // 1. Hızlı Barkod Okuyucu Dinleyicisi
    barkodInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); 
            const hamVeri = this.value.toUpperCase().trim();
            if (hamVeri) {
                // Ham veriyi hem seriNo hem de barkodHamVeri olarak gönderiyoruz.
                akilliStokAra(hamVeri, 'YOK', 'YOK', 'YOK', DEPO_KODU, hamVeri); 
            }
        }
    });

    // 2. Detaylı Arama Düğmesi
    document.getElementById('ara-btn').addEventListener('click', function() {
        const stokKod = stokKodInput.value.toUpperCase().trim();
        const partiNo = partiNoInput.value.toUpperCase().trim();
        const renk = renkInput.value.toUpperCase().trim();

        akilliStokAra(currentSeriNo, stokKod, partiNo, renk, DEPO_KODU, 'YOK');
    });

    // 3. Kamera/Dosya Butonları
    document.getElementById('select-file-btn').addEventListener('click', () => {
        document.getElementById('image-input').click();
    });

    document.getElementById('camera-btn').addEventListener('click', () => {
        // Tarayıcının Kamera API'sini doğrudan tetiklemek için input'u kullanıyoruz
        document.getElementById('image-input').setAttribute('capture', 'environment');
        document.getElementById('image-input').click();
    });

    document.getElementById('image-input').addEventListener('change', function() {
        if (this.files.length > 0) {
            geminiOku(this.files[0]);
        }
        // Capture özelliğini sonraki dosya seçimleri için kaldır
        this.removeAttribute('capture');
    });

    // 4. Sayım Kaydetme Düğmesi
    document.getElementById('sayim_kaydet_btn').addEventListener('click', function() {
        const miktar = miktarInput.value;

        if (!currentStokKod || currentStokKod === 'YOK') {
            document.getElementById('kayit_mesaji').className = 'message error';
            document.getElementById('kayit_mesaji').innerText = 'Lütfen önce geçerli bir stok bulun.';
            return;
        }
        if (parseFloat(miktar) <= 0 || isNaN(parseFloat(miktar))) {
            document.getElementById('kayit_mesaji').className = 'message error';
            document.getElementById('kayit_mesaji').innerText = 'Miktar geçerli bir sayı olmalıdır (> 0).';
            return;
        }

        const data = {
            stok_kod: currentStokKod,
            parti_no: currentPartiNo,
            renk: currentRenk,
            miktar: miktar,
            depo_kod: DEPO_KODU,
            personel_adi: PERSONEL_ADI 
        };

        fetch(`/ajax/sayim-kaydet/${SAYIM_EMRI_ID}/`, {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': CSRF_TOKEN, 
            },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('kayit_mesaji').className = 'message success';
                document.getElementById('kayit_mesaji').innerText = data.message;
                document.getElementById('yeni_toplam_goster').innerText = data.yeni_miktar;
                miktarInput.value = ''; 
            } else {
                document.getElementById('kayit_mesaji').className = 'message error';
                document.getElementById('kayit_mesaji').innerText = data.message;
            }
        })
        .catch(error => {
            document.getElementById('kayit_mesaji').className = 'message error';
            document.getElementById('kayit_mesaji').innerText = `Kayıt sırasında hata: ${error.message}`;
        });
    });

    // Sayfa yüklendiğinde bir ilk arama tetikle
    document.addEventListener('DOMContentLoaded', () => {
        akilliStokAra('YOK', 'YOK', 'YOK', 'YOK', DEPO_KODU, 'YOK');
    });
</script>
</body>
</html>