{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Stok Sayƒ±m Giri≈üi | {{ sayim_emri.ad }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* SADE VE ƒ∞≈ûLEVSEL TEMEL STƒ∞LLER */
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; background-color: #f4f7f6; }
        input[type="text"], input[type="number"], button, select { padding: 10px; margin: 5px 0; display: block; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .info-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; background-color: white; border-radius: 4px; }
        .message.success { color: green; font-weight: bold; }
        .message.error { color: red; font-weight: bold; }
        hr { border: 0; border-top: 1px solid #ccc; margin: 20px 0; }
        .flex-container { display: flex; gap: 10px; margin-bottom: 10px; }
        .flex-container > div { flex: 1; }
        .section-header { margin-top: 15px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; }
        
        /* Ek Durum Stil Tanƒ±mlarƒ± */
        #urun_bilgi_alani.status-found { border-left: 5px solid green; padding-left: 10px; }
        #urun_bilgi_alani.status-missing { border-left: 5px solid red; padding-left: 10px; }
    </style>
</head>
<body>
    <div class="info-box">
        <h3>Sayƒ±m Bilgileri</h3>
        <p>Sayƒ±m Emri: <strong>{{ sayim_emri.ad }}</strong> (ID: {{ sayim_emri.pk }})</p>
        <p>Depo Kodu: <strong id="depo_kodu_gizli">{{ depo_kodu }}</strong></p>
        <p>Personel: <strong id="personel_adi_gizli">{{ personel_adi }}</strong></p>
        <a href="{% url 'raporlama_onay' pk=sayim_emri.pk %}">Raporlama ve Onay Ekranƒ±na Git</a>
    </div>

    <h2>1. Stok Arama ve Veri Giri≈üi</h2>
    
    <div class="info-box">
        <h3 class="section-header">A. Seri No / Barkod Giri≈üi</h3>
        <input type="text" id="barkod_input" placeholder="Seri No/Barkodu buraya girin (ENTER)">
        <p style="font-size: 0.9em; color: gray;">(Otomatik arama i√ßin ENTER tu≈üunu kullanƒ±n.)</p>
    </div>

    <hr>
    
    <h2>1.B. Yapay Zeka (Gemini/OCR) Giri≈üi</h2>

    <div class="info-box">
        <div class="flex-container">
            <div>
                <button id="select-file-btn" type="button">üìÅ Dosyadan Se√ß</button>
            </div>
            <div>
                <button id="camera-btn" type="button" style="background-color: #ffc107; color: black;">üì∑ Kamerayƒ± A√ß</button>
            </div>
        </div>
        
        <input type="file" id="image-input" accept="image/*" style="display: none;">

        <p style="font-size: 0.9em; color: gray; margin-top: 10px;">(Gemini Vision ile barkod, stok kodu ve miktar okuma.)</p>
        
        <p id="gemini_mesaj" class="message"></p>
    </div>
    <hr>
    <h3 class="section-header">Veya Detaylƒ± Giri≈ü</h3>
    
    <div id="stok_kod_container">
        <input type="text" id="stok_kod_input" placeholder="Stok Kodu">
    </div>
    <div id="parti_no_container">
        <input type="text" id="parti_no_input" placeholder="Parti No (Opsiyonel)">
    </div>
    <div id="renk_container">
        <input type="text" id="renk_input" placeholder="Renk/Varyant (Opsiyonel)">
    </div>
    <button id="ara-btn">Stok Ara</button>

    <div id="urun_bilgi_alani" style="margin-top: 15px;">
        <p>√úr√ºn: <strong id="urun_bilgi">Stok kodu veya Barkod girin...</strong></p>
        <p>Sistem Stoƒüu: <strong id="sistem_stok_goster">0.00</strong></p>
        <p>Son Sayƒ±m: <strong id="last_sayim_goster">Bilinmiyor</strong></p>
    </div>

    <hr>

    <h2>2. Sayƒ±m Giri≈üi</h2>
    
    <input type="number" id="miktar_input" placeholder="Sayƒ±m Miktarƒ± (√ñrn: 1.00)">
    <button id="sayim_kaydet_btn" style="background-color: #28a745;">KAYDET (**ENTER**)</button>
    <p class="message" id="kayit_mesaji"></p>
    <p>Yeni Toplam Sayƒ±m: <strong id="yeni_toplam_goster">0.00</strong></p>


<script>
    // **********************************************
    // GEMINI OKU FONKSƒ∞YONU BURAYA EKLENDƒ∞
    // **********************************************
    
    // --- YZ (GEMINI VISION) OKUMA FONKSƒ∞YONU ---
    function geminiOku(file) {
        const SAYIM_EMRI_ID = document.getElementById('depo_kodu_gizli').innerText.trim(); // Sayƒ±m Emri ID'nizi buradan almalƒ±sƒ±nƒ±z
        const DEPO_KODU = document.getElementById('depo_kodu_gizli').innerText.trim();
        const barkodInput = document.getElementById('barkod_input');
        const miktarInput = document.getElementById('miktar_input');
        
        document.getElementById('gemini_mesaj').className = 'message';
        document.getElementById('gemini_mesaj').innerText = 'üì∏ G√∂rsel y√ºkleniyor ve Gemini ile analiz ediliyor... Bu biraz s√ºrebilir.';
        
        const formData = new FormData();
        formData.append('image_file', file);
        formData.append('sayim_emri_id', SAYIM_EMRI_ID);
        formData.append('depo_kodu', DEPO_KODU);

        // CSRF Token Fonksiyonu (Django POST i√ßin kritik)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const CSRF_TOKEN = getCookie('csrftoken');

        // Dƒ∞KKAT: /ajax/gemini-ocr-analiz/ adresini Django views.py'da tanƒ±mlamanƒ±z gerekiyor.
        fetch(`/ajax/gemini-ocr-analiz/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
            },
            body: formData
        })
        .then(res => {
            if (!res.ok) {
                // Hata durumunda bile JSON d√∂nmeye √ßalƒ±≈ü
                return res.json().catch(() => {
                    throw new Error(`Sunucu Hatasƒ± (${res.status}): Yanƒ±t JSON formatƒ±nda deƒüil.`);
                });
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                document.getElementById('gemini_mesaj').className = 'message success';
                document.getElementById('gemini_mesaj').innerText = `‚úÖ YZ Ba≈üarƒ±lƒ±: Barkod/Seri No: ${data.barkod || '-'} | Miktar: ${data.miktar || '-'}`;

                // 1. Oku-Kodu ana barkod giri≈ü alanƒ±na yaz
                barkodInput.value = data.barkod || ''; 
                
                // 2. Miktarƒ± Miktar giri≈ü alanƒ±na yaz
                miktarInput.value = data.miktar || ''; 

                // 3. Stok kodu/barkod alanƒ± dolduysa, otomatik arama tetikle
                if (barkodInput.value) {
                    akilliStokAra(barkodInput.value.toUpperCase().trim(), 'YOK', 'YOK', 'YOK', DEPO_KODU, barkodInput.value.toUpperCase().trim());
                    miktarInput.focus(); // Kullanƒ±cƒ± doƒürudan miktarƒ± kontrol edip kaydetsin
                }

            } else {
                document.getElementById('gemini_mesaj').className = 'message error';
                document.getElementById('gemini_mesaj').innerText = `‚ùå YZ Hatasƒ±: ${data.message || 'Analiz ba≈üarƒ±sƒ±z oldu.'}`;
            }
        })
        .catch(error => {
            document.getElementById('gemini_mesaj').className = 'message error';
            document.getElementById('gemini_mesaj').innerText = `Kritik Hata: ${error.message}`;
        });
    }


    document.addEventListener('DOMContentLoaded', () => {
        // --- TEMEL TANIMLAR ---
        const SAYIM_EMRI_ID = "{{ sayim_emri.pk }}";
        const DEPO_KODU = document.getElementById('depo_kodu_gizli').innerText.trim();
        const PERSONEL_ADI = document.getElementById('personel_adi_gizli').innerText.trim();

        // DOM Elementleri
        const barkodInput = document.getElementById('barkod_input');
        const stokKodInput = document.getElementById('stok_kod_input');
        const miktarInput = document.getElementById('miktar_input');
        
        const partiNoContainer = document.getElementById('parti_no_container');
        const renkContainer = document.getElementById('renk_container');
        const urunBilgiAlani = document.getElementById('urun_bilgi_alani');
        const imageInput = document.getElementById('image-input'); // YENƒ∞: Gizli dosya inputu

        let currentStokKod = '';
        let currentPartiNo = 'YOK';
        let currentRenk = 'YOK';
        let currentSeriNo = 'YOK';

        // CSRF Token Fonksiyonu (Django POST i√ßin kritik)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const CSRF_TOKEN = getCookie('csrftoken');


        // --- VARYANT DROPDOWN OLU≈ûTURMA ƒ∞≈ûLEVƒ∞ ---
        function updateVariantInputs(data) {
            const createInput = (id, placeholder, value) => 
                `<input type="text" id="${id}" placeholder="${placeholder}" value="${value || ''}">`;
            
            // 1. Parti No i√ßin
            if (data.parti_varyantlar && data.parti_varyantlar.length > 0) {
                let options = data.parti_varyantlar.map(p => `<option value="${p}">${p}</option>`).join('');
                const selectedParti = data.parti_no || data.parti_varyantlar[0];
                options = `<option value="${selectedParti}" selected>${selectedParti}</option>` + options.replace(`<option value="${selectedParti}">`, '').replace(`</option>`, '');
                partiNoContainer.innerHTML = `<select id="parti_no_input">${options}</select>`;
            } else {
                partiNoContainer.innerHTML = createInput('parti_no_input', 'Parti No (Opsiyonel)', data.parti_no);
            }

            // 2. Renk/Varyant i√ßin
            if (data.renk_varyantlar && data.renk_varyantlar.length > 0) {
                let options = data.renk_varyantlar.map(r => `<option value="${r}">${r}</option>`).join('');
                const selectedRenk = data.renk || data.renk_varyantlar[0];
                options = `<option value="${selectedRenk}" selected>${selectedRenk}</option>` + options.replace(`<option value="${selectedRenk}">`, '').replace(`</option>`, '');
                renkContainer.innerHTML = `<select id="renk_input">${options}</select>`;
            } else {
                renkContainer.innerHTML = createInput('renk_input', 'Renk/Varyant (Opsiyonel)', data.renk);
            }
            
            // Yeni DOM elementleri olu≈üturulduƒüu i√ßin, onlara ENTER dinleyicilerini yeniden kur
            setupAutoSearchListeners(); 
        }


        // --- Hƒ∞BRƒ∞T ARAMA FONKSƒ∞YONU (views.py'ƒ± √ßaƒüƒ±rƒ±r) ---
        function akilliStokAra(seriNo, stokKod, partiNo, renk, depoKod, barkodHamVeri = '') {
            document.getElementById('urun_bilgi').innerText = 'Arama yapƒ±lƒ±yor...';
            document.getElementById('sistem_stok_goster').innerText = '0.00';
            document.getElementById('last_sayim_goster').innerText = 'Bilinmiyor';
            document.getElementById('kayit_mesaji').innerText = ''; 
            urunBilgiAlani.classList.remove('status-found', 'status-missing'); 
            urunBilgiAlani.classList.add('status-default'); 

            const params = new URLSearchParams({
                seri_no: seriNo || 'YOK',
                stok_kod: stokKod || 'YOK',
                parti_no: partiNo || 'YOK',
                renk: renk || 'YOK',
                depo_kod: depoKod,
                barkod_ham_veri: barkodHamVeri || 'YOK'
            });

            fetch(`/ajax/stok-ara-akilli/?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Sunucu Hatasƒ± (${response.status}). Yanƒ±t JSON deƒüil.`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('urun_bilgi').innerText = data.urun_bilgi;
                    document.getElementById('last_sayim_goster').innerText = data.last_sayim;
                    
                    // Global deƒüi≈ükenleri g√ºncelle
                    currentStokKod = data.stok_kod;
                    currentPartiNo = data.parti_no;
                    currentRenk = data.renk;
                    currentSeriNo = seriNo;
                    
                    if (data.found) {
                        // Tam e≈üle≈üme bulundu
                        stokKodInput.value = data.stok_kod;
                        document.getElementById('sistem_stok_goster').innerText = data.sistem_stok;
                        urunBilgiAlani.classList.add('status-found'); 

                        updateVariantInputs({ parti_no: data.parti_no, renk: data.renk });

                    } else if (data.parti_varyantlar && data.parti_varyantlar.length > 0 || data.renk_varyantlar && data.renk_varyantlar.length > 0) {
                        // Stok koduna g√∂re varyantlar bulundu (Dropdown'a d√∂n√º≈üt√ºr)
                        currentStokKod = data.stok_kod;
                        currentPartiNo = partiNo;
                        currentRenk = renk;
                        urunBilgiAlani.classList.add('status-default'); 

                        updateVariantInputs(data);
                    } else {
                        // E≈üle≈üme yok
                        urunBilgiAlani.classList.add('status-missing'); 
                        
                        updateVariantInputs({ parti_no: partiNo, renk: renk });
                    }
                    
                    // G√ºncel Dropdown/Input deƒüerleriyle current deƒüerleri senkronize et
                    const partiNoElement = document.getElementById('parti_no_input');
                    const renkElement = document.getElementById('renk_input');
                    currentPartiNo = partiNoElement ? partiNoElement.value.toUpperCase().trim() : 'YOK';
                    currentRenk = renkElement ? renkElement.value.toUpperCase().trim() : 'YOK';
                })
                .catch(error => {
                    document.getElementById('urun_bilgi').innerText = `Arama Hatasƒ±: ${error.message}`;
                    urunBilgiAlani.classList.add('status-missing'); 
                });
        }

        // --- OLAY Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞ ---
        
        // YENƒ∞: T√ºm arama inputlarƒ± i√ßin ENTER/CHANGE dinleyicisi (DROPDOWN D√úZELTMESƒ∞)
        function setupAutoSearchListeners() {
            const allInputs = [barkodInput, document.getElementById('stok_kod_input'), 
                                document.getElementById('parti_no_input'), 
                                document.getElementById('renk_input')];
            
            // Dinleyicileri temizle (√áift tetiklemeyi √∂nlemek i√ßin)
            allInputs.forEach(input => {
                if(input) {
                    input.removeEventListener('keydown', handleSearchEnter);
                    input.removeEventListener('change', handleSearchEnter);
                }
            });
            
            // Yeni dinleyicileri kur
            allInputs.forEach(input => {
                if (input) {
                    if(input.tagName === 'INPUT') {
                        input.addEventListener('keydown', handleSearchEnter);
                    } else if (input.tagName === 'SELECT') {
                        input.addEventListener('change', handleSearchEnter);
                    }
                }
            });
        }

        function handleSearchEnter(event) {
            if (event.type === 'keydown' && event.key !== 'Enter') {
                return;
            }
            if (event.type === 'keydown') {
                event.preventDefault(); 
            }

            const partiNoElement = document.getElementById('parti_no_input');
            const renkElement = document.getElementById('renk_input');
            
            const currentPartiNo = partiNoElement ? partiNoElement.value.toUpperCase().trim() : 'YOK';
            const currentRenk = renkElement ? renkElement.value.toUpperCase().trim() : 'YOK';
            const currentStokKod = stokKodInput.value.toUpperCase().trim();
            const currentSeriNo = barkodInput.value.toUpperCase().trim();
            
            
            if (event.target.id === 'barkod_input') {
               akilliStokAra(currentSeriNo, 'YOK', 'YOK', 'YOK', DEPO_KODU, currentSeriNo);
            } else {
               akilliStokAra('YOK', currentStokKod, currentPartiNo, currentRenk, DEPO_KODU, 'YOK');
            }
        }


        // 3. KAMERA/DOSYA BUTONLARI (B√∂l√ºm B - Gemini/OCR) Dinleyicileri
        function setupGeminiListeners() {
            // Dosyadan Se√ß butonu tƒ±klandƒ±ƒüƒ±nda gizli input'u tetikle
            document.getElementById('select-file-btn').addEventListener('click', () => {
                imageInput.removeAttribute('capture'); // Kamera modunu kapat
                imageInput.click();
            });

            // Kamera butonu tƒ±klandƒ±ƒüƒ±nda gizli input'u kamera modunda tetikle
            document.getElementById('camera-btn').addEventListener('click', () => {
                imageInput.setAttribute('capture', 'environment'); // Arka kamerayƒ± a√ß
                imageInput.click();
            });

            // G√∂r√ºnt√º se√ßildiƒüinde/√ßekildiƒüinde Gemini'yi tetikle
            imageInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    geminiOku(this.files[0]); 
                }
                this.removeAttribute('capture');
            });
        }


        // 4. Detaylƒ± Arama D√ºƒümesi
        document.getElementById('ara-btn').addEventListener('click', function() {
            const partiNoElement = document.getElementById('parti_no_input');
            const renkElement = document.getElementById('renk_input');
            
            const stokKod = stokKodInput.value.toUpperCase().trim();
            const partiNo = partiNoElement ? partiNoElement.value.toUpperCase().trim() : 'YOK'; 
            const renk = renkElement ? renkElement.value.toUpperCase().trim() : 'YOK';
            
            akilliStokAra('YOK', stokKod, partiNo, renk, DEPO_KODU, 'YOK');
        });

        // 5. Sayƒ±m Kaydetme D√ºƒümesi
        document.getElementById('sayim_kaydet_btn').addEventListener('click', function() {
            const miktar = miktarInput.value;

            if (!currentStokKod || currentStokKod === 'YOK') {
                document.getElementById('kayit_mesaji').className = 'message error';
                document.getElementById('kayit_mesaji').innerText = 'L√ºtfen √∂nce ge√ßerli bir stok bulun.';
                return;
            }
            if (parseFloat(miktar) <= 0 || isNaN(parseFloat(miktar))) {
                document.getElementById('kayit_mesaji').className = 'message error';
                document.getElementById('kayit_mesaji').innerText = 'Miktar ge√ßerli bir sayƒ± olmalƒ±dƒ±r (> 0).';
                return;
            }

            const data = {
                stok_kod: currentStokKod,
                parti_no: currentPartiNo,
                renk: currentRenk,
                miktar: miktar,
                depo_kod: DEPO_KODU,
                personel_adi: PERSONEL_ADI 
            };

            fetch(`/ajax/kaydet/${SAYIM_EMRI_ID}/`, {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    'X-CSRFToken': CSRF_TOKEN, 
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('kayit_mesaji').className = 'message success';
                    document.getElementById('kayit_mesaji').innerText = data.message;
                    document.getElementById('yeni_toplam_goster').innerText = data.yeni_miktar;
                    miktarInput.value = ''; 
                } else {
                    document.getElementById('kayit_mesaji').className = 'message error';
                    document.getElementById('kayit_mesaji').innerText = data.message;
                }
            })
            .catch(error => {
                document.getElementById('kayit_mesaji').className = 'message error';
                document.getElementById('kayit_mesaji').innerText = `Kritik Kayƒ±t Hatasƒ±: Sunucuya ula≈üƒ±lamadƒ±. ${error.message}`;
            });
        });

        // Sayfa tamamen y√ºklendiƒüinde t√ºm olay dinleyicilerini kur ve ilk aramayƒ± yap
        setupGeminiListeners();
        setupAutoSearchListeners();
        
        // ƒ∞lk y√ºklemede, eƒüer barkod veya stok kodu bo≈üsa, varsayƒ±lan bir arama yap
        if (!barkodInput.value && !stokKodInput.value) {
            akilliStokAra('YOK', 'YOK', 'YOK', 'YOK', DEPO_KODU, 'YOK');
        }
    });
</script>
</body>
</html>