{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Stok Sayım Girişi | {{ sayim_emri.ad }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode@2.3.9/html5-qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Ana Stil ve Düzen */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 600px; margin: auto; background-color: #f4f7f6; }
        .container { background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 20px; color: #333; }
        .section-header { color: #007bff; margin-bottom: 15px; }

        /* Input ve Buton Stilleri */
        input[type="text"], input[type="number"], button, select { 
            padding: 12px; margin: 8px 0; display: block; width: 100%; box-sizing: border-box; 
            border: 1px solid #c0c0c0; border-radius: 6px; font-size: 1em; 
        }
        button { cursor: pointer; transition: background-color 0.3s; }
        
        /* Dinamik Bilgi Alanları (Sistem Stoğu ve Ürün Bilgisi) */
        .info-box-status { 
            padding: 10px; border-radius: 4px; margin-top: 5px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        #last_sayim_goster_container { background-color: #fffacd; border: 1px solid #ffebcd; } /* Sarı */
        
        /* Durum Renkleri */
        .status-found { background-color: #e6ffe6; border: 1px solid #00c853; color: #004d40; font-weight: bold; } /* Yeşil */
        .status-missing { background-color: #ffe6e6; border: 1px solid #d50000; color: #880000; } /* Kırmızı */
        .status-default { background-color: #fff; } /* Varsayılan */

        /* Buton Renkleri */
        .btn-primary { background-color: #007bff; color: white; border: none; }
        .btn-secondary { background-color: #6c757d; color: white; border: none; }
        .btn-success { background-color: #28a745; color: white; border: none; }

        .flex-container { display: flex; gap: 10px; margin-bottom: 10px; }
        #scanner-container { display: none; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="info-box">
            <h3>Sayım Bilgileri</h3>
            <p>Sayım Emri: <strong>{{ sayim_emri.ad }}</strong> (ID: {{ sayim_emri.pk }})</p>
            <p>Depo Kodu: <strong>{{ depo_kodu }}</strong></p>
            <p>Personel: <strong>{{ personel_adi }}</strong></p>
            <a href="{% url 'raporlama_onay' pk=sayim_emri.pk %}" class="btn-primary" 
               style="text-align: center; text-decoration: none; padding: 10px 15px; border-radius: 5px; margin-top: 10px;">
                Raporlama ve Onay Ekranına Git
            </a>
        </div>

        <h2>1. Stok Arama ve Veri Girişi</h2>
        
        <div class="info-box">
            <h3 class="section-header">A. Hızlı Barkod / QR Okuma</h3>
            <input type="text" id="barkod_input" placeholder="Barkod/Seri No'yu okutun (ENTER)">
            <button id="quick-scan-btn" class="btn-primary" style="margin-top: 5px;">
                📸 QR/Barkod Tarayıcıyı Aç
            </button>
            <div id="scanner-container"></div>
        </div>

        <hr>
        
        <div class="info-box">
            <h3 class="section-header">B. Etiket Görüntüsü ile Giriş (Gemini/OCR)</h3>
            <p style="font-size: 0.9em; color: #555;">(Karmaşık etiketlerden Stok, Parti ve Renk okuma)</p>
            
            <div class="flex-container">
                <button id="camera-btn" class="btn-secondary" style="background-color: #556B2F;">📷 Kamera ile Çek</button>
                <input type="file" id="image-input" accept="image/*" style="display: none;">
                <button id="select-file-btn" class="btn-secondary" style="background-color: #8A2BE2;">📂 Dosyadan Seç</button>
            </div>
            <div id="ocr_status" class="message" style="margin-top: 5px;"></div>
        </div>
        
        <hr>

        <h3 class="section-header">Veya Detaylı Giriş</h3>
        
        <div id="stok_kod_container">
            <input type="text" id="stok_kod_input" placeholder="Stok Kodu">
        </div>
        <div id="parti_no_container">
            <input type="text" id="parti_no_input" placeholder="Parti No (Opsiyonel)">
        </div>
        <div id="renk_container">
            <input type="text" id="renk_input" placeholder="Renk/Varyant (Opsiyonel)">
        </div>
        <button id="ara-btn">Stok Ara</button>

        <div id="urun_bilgi_alani" class="info-box-status status-default">
            <span id="urun_bilgi">Stok kodu veya Barkod girin...</span>
        </div>
        
        <div class="info-box-status" id="sistem_stok_goster_container">
            <span>Sistem Stoğu:</span> <strong id="sistem_stok_goster">0.00</strong>
        </div>
        
        <div class="info-box-status" id="last_sayim_goster_container" style="background-color: #fffacd; border: 1px solid #ffebcd;">
            <span>Son Sayım:</span> <strong id="last_sayim_goster">Bilinmiyor</strong>
        </div>

        <hr>

        <h2>2. Sayım Girişi</h2>
        
        <input type="number" id="miktar_input" placeholder="Sayım Miktarı (Örn: 1.00)">
        <button id="sayim_kaydet_btn" class="btn-success">KAYDET (**ENTER**)</button>
        <p class="message" id="kayit_mesaji"></p>
        <p>Yeni Toplam Sayım: <strong id="yeni_toplam_goster">0.00</strong></p>
    </div> <script>
    // --- TEMEL TANIMLAR ---
    const SAYIM_EMRI_ID = "{{ sayim_emri.pk }}";
    const DEPO_KODU = document.getElementById('depo_kodu_gizli').innerText.trim();
    const PERSONEL_ADI = document.getElementById('personel_adi_gizli').innerText.trim();

    // DOM Elementleri
    const barkodInput = document.getElementById('barkod_input');
    const stokKodInput = document.getElementById('stok_kod_input');
    const miktarInput = document.getElementById('miktar_input');
    const ocrStatus = document.getElementById('ocr_status');
    const scannerContainer = document.getElementById('scanner-container');
    
    const partiNoContainer = document.getElementById('parti_no_container');
    const renkContainer = document.getElementById('renk_container');
    const urunBilgiAlani = document.getElementById('urun_bilgi_alani'); // Yeni
    const sistemStokGosterContainer = document.getElementById('sistem_stok_goster_container'); // Yeni

    let currentStokKod = '';
    let currentPartiNo = 'YOK';
    let currentRenk = 'YOK';
    let currentSeriNo = 'YOK';

    // CSRF Token Fonksiyonu (Django POST için kritik)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const CSRF_TOKEN = getCookie('csrftoken');


    // --- YENİ: VARYANT DROPDOWN OLUŞTURMA İŞLEVİ ---
    function updateVariantInputs(data) {
        const createInput = (id, placeholder, value) => 
            `<input type="text" id="${id}" placeholder="${placeholder}" value="${value || ''}">`;
        
        // 1. Parti No için
        if (data.parti_varyantlar && data.parti_varyantlar.length > 0) {
            let options = data.parti_varyantlar.map(p => `<option value="${p}">${p}</option>`).join('');
            partiNoContainer.innerHTML = `<select id="parti_no_input">${options}</select>`;
        } else {
            partiNoContainer.innerHTML = createInput('parti_no_input', 'Parti No (Opsiyonel)', data.parti_no);
        }

        // 2. Renk/Varyant için
        if (data.renk_varyantlar && data.renk_varyantlar.length > 0) {
            let options = data.renk_varyantlar.map(r => `<option value="${r}">${r}</option>`).join('');
            renkContainer.innerHTML = `<select id="renk_input">${options}</select>`;
        } else {
            renkContainer.innerHTML = createInput('renk_input', 'Renk/Varyant (Opsiyonel)', data.renk);
        }
        
        // Yeni DOM elementleri oluşturulduğu için, onlara ENTER dinleyicilerini yeniden kur
        setupAutoSearchListeners(); 
    }


    // --- HİBRİT ARAMA FONKSİYONU (views.py'ı çağırır) ---
    function akilliStokAra(seriNo, stokKod, partiNo, renk, depoKod, barkodHamVeri = '') {
        document.getElementById('urun_bilgi').innerText = 'Arama yapılıyor...';
        document.getElementById('sistem_stok_goster').innerText = '0.00';
        document.getElementById('last_sayim_goster').innerText = 'Bilinmiyor';
        document.getElementById('kayit_mesaji').innerText = ''; 
        urunBilgiAlani.className = 'info-box-status status-default'; // Varsayılan renk
        sistemStokGosterContainer.className = 'info-box-status'; // Varsayılan renk

        const params = new URLSearchParams({
            seri_no: seriNo || 'YOK',
            stok_kod: stokKod || 'YOK',
            parti_no: partiNo || 'YOK',
            renk: renk || 'YOK',
            depo_kod: depoKod,
            barkod_ham_veri: barkodHamVeri || 'YOK'
        });

        fetch(`/ajax/stok-ara-akilli/?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Sunucu Hatası (${response.status}). Yanıt JSON değil.`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('urun_bilgi').innerText = data.urun_bilgi;
                document.getElementById('last_sayim_goster').innerText = data.last_sayim;
                
                // Kayıt için kullanılacak global değişkenleri güncelle
                currentStokKod = data.stok_kod;
                currentPartiNo = data.parti_no;
                currentRenk = data.renk;
                currentSeriNo = seriNo;
                
                if (data.found) {
                    // Tam eşleşme bulundu: Input alanlarını bulgularla güncelle
                    stokKodInput.value = data.stok_kod;
                    document.getElementById('sistem_stok_goster').innerText = data.sistem_stok;
                    urunBilgiAlani.classList.add('status-found'); // YEŞİL yap
                    
                    // Dropdown'ları normal input'a dönüştür (Eşleşen parti/renk değeri ile)
                    updateVariantInputs({ parti_no: data.parti_no, renk: data.renk });

                } else if (data.parti_varyantlar && data.parti_varyantlar.length > 0 || data.renk_varyantlar && data.renk_varyantlar.length > 0) {
                    // Stok koduna göre varyantlar bulundu (Dropdown'a dönüştür)
                    currentStokKod = data.stok_kod;
                    currentPartiNo = partiNo;
                    currentRenk = renk;
                    urunBilgiAlani.classList.add('status-default'); // Varsayılan
                    
                    // KRİTİK: Dropdown'ları oluştur (mevcut parti/renk değerlerini koruyarak)
                    updateVariantInputs(data);
                } else {
                    // Eşleşme yok
                    urunBilgiAlani.classList.add('status-missing'); // KIRMIZI yap
                    
                    // Input alanlarını varsayılan değere dönüştür
                    updateVariantInputs({ parti_no: partiNo, renk: renk });
                }
                
                // Güncel Dropdown/Input değerleriyle current değerleri senkronize et
                const partiNoElement = document.getElementById('parti_no_input');
                const renkElement = document.getElementById('renk_input');
                currentPartiNo = partiNoElement.value.toUpperCase().trim();
                currentRenk = renkElement.value.toUpperCase().trim();
            })
            .catch(error => {
                document.getElementById('urun_bilgi').innerText = `Arama Hatası: ${error.message}`;
                urunBilgiAlani.classList.add('status-missing'); // KIRMIZI yap
            });
    }

    // --- GEMINI/OCR İŞLEMLERİ (Bölüm B) ---
    function geminiOku(file) {
        ocrStatus.className = 'message';
        ocrStatus.innerText = '🔍 Resmi analiz ediyoruz (Gemini Vision)...';

        const formData = new FormData();
        formData.append('image', file);
        
        fetch("{% url 'gemini_parti_oku' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                ocrStatus.className = 'message success';
                ocrStatus.innerText = data.message;
                
                // Form alanlarını Gemini'dan gelen verilerle doldur
                barkodInput.value = data.seri_no; 
                stokKodInput.value = data.stok_kod;

                // 2. Adım: Arama fonksiyonunu tetikle
                akilliStokAra(
                    data.seri_no, 
                    data.stok_kod, 
                    data.parti_no,
                    data.renk,
                    DEPO_KODU, 
                    data.barkod_ham_veri
                );
            } else {
                ocrStatus.className = 'message error';
                ocrStatus.innerText = `OCR Hatası: ${data.message}`;
            }
        })
        .catch(error => {
            ocrStatus.className = 'message error';
            ocrStatus.innerText = `Kritik Hata: Gemini Sunucusuna ulaşılamadı. ${error.message}`;
        });
    }

    // --- OLAY DİNLEYİCİLERİ ---
    
    // YENİ: Tüm arama inputları için ENTER/CHANGE dinleyicisi (DROPDOWN DÜZELTMESİ)
    function setupAutoSearchListeners() {
        const allInputs = [barkodInput, document.getElementById('stok_kod_input'), 
                           document.getElementById('parti_no_input'), 
                           document.getElementById('renk_input')];
        
        // Dinleyicileri temizle (Çift tetiklemeyi önlemek için)
        allInputs.forEach(input => {
            if(input) {
                input.removeEventListener('keydown', handleSearchEnter);
                input.removeEventListener('change', handleSearchEnter);
            }
        });
        
        // Yeni dinleyicileri kur
        allInputs.forEach(input => {
            if (input) {
                if(input.tagName === 'INPUT') {
                    input.addEventListener('keydown', handleSearchEnter);
                } else if (input.tagName === 'SELECT') {
                    input.addEventListener('change', handleSearchEnter);
                }
            }
        });
    }

    function handleSearchEnter(event) {
        if (event.type === 'keydown' && event.key !== 'Enter') {
            return;
        }
        if (event.type === 'keydown') {
            event.preventDefault(); 
        }

        const partiNoElement = document.getElementById('parti_no_input');
        const renkElement = document.getElementById('renk_input');
        
        const currentPartiNo = partiNoElement.value.toUpperCase().trim();
        const currentRenk = renkElement.value.toUpperCase().trim();
        const currentStokKod = stokKodInput.value.toUpperCase().trim();
        const currentSeriNo = barkodInput.value.toUpperCase().trim();
        
        
        if (event.target.id === 'barkod_input') {
           // Seri No input'u ENTER ile tetiklenirse, onu Seri No/Ham Veri olarak öncelikli ara
           akilliStokAra(currentSeriNo, 'YOK', 'YOK', 'YOK', DEPO_KODU, currentSeriNo);
        } else {
           // Stok Kodu, Parti No veya Renk input'u/select'i değiştiyse
           akilliStokAra('YOK', currentStokKod, currentPartiNo, currentRenk, DEPO_KODU, 'YOK');
        }
    }


    // 2. HTML5 BARKOD TARAYICI (Bölüm A) - QR/BARKOD TARAYICIYI AÇ BUTONU
    function setupQuickScanListener() {
        const quickScanBtn = document.getElementById('quick-scan-btn');
        if (!quickScanBtn) return;
        
        quickScanBtn.addEventListener('click', () => {
            scannerContainer.style.display = 'block';
            
            const html5QrCode = new Html5Qrcode("scanner-container");
            
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                html5QrCode.stop().then(() => {
                    scannerContainer.innerHTML = '';
                    scannerContainer.style.display = 'none';
                    quickScanBtn.style.display = 'block'; 
                    
                    barkodInput.value = decodedText.toUpperCase().trim(); 
                    akilliStokAra(decodedText, 'YOK', 'YOK', 'YOK', DEPO_KODU, decodedText); 
                    
                }).catch(err => { console.error("Tarayıcı durdurulurken hata oluştu:", err); });
            };

            const config = { fps: 10, qrbox: { width: 250, height: 250 }, rememberLastUsedCamera: true };

            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .then(() => {
                    quickScanBtn.style.display = 'none'; 
                    scannerContainer.style.height = '300px'; 
                })
                .catch((err) => {
                    scannerContainer.innerHTML = `<p style="color:red;">Kamera Hatası: Lütfen kamera izinlerini kontrol edin veya Dosyadan Seç'i kullanın. Detay: ${err}</p>`;
                    console.error("Tarayıcı başlatılamadı:", err);
                    scannerContainer.style.display = 'block'; 
                    quickScanBtn.style.display = 'block'; 
                });
        });
    }

    // 3. KAMERA/DOSYA BUTONLARI (Bölüm B - Gemini/OCR)
    function setupGeminiListeners() {
        document.getElementById('select-file-btn').addEventListener('click', () => {
            document.getElementById('image-input').click();
        });

        document.getElementById('camera-btn').addEventListener('click', () => {
            document.getElementById('image-input').setAttribute('capture', 'environment');
            document.getElementById('image-input').click();
        });

        document.getElementById('image-input').addEventListener('change', function() {
            if (this.files.length > 0) {
                geminiOku(this.files[0]);
            }
            this.removeAttribute('capture');
        });
    }


    // 4. Detaylı Arama Düğmesi
    document.getElementById('ara-btn').addEventListener('click', function() {
        const partiNoElement = document.getElementById('parti_no_input');
        const renkElement = document.getElementById('renk_input');
        
        const stokKod = stokKodInput.value.toUpperCase().trim();
        const partiNo = partiNoElement.value.toUpperCase().trim(); 
        const renk = renkElement.value.toUpperCase().trim();
        
        akilliStokAra('YOK', stokKod, partiNo, renk, DEPO_KODU, 'YOK');
    });

    // 5. Sayım Kaydetme Düğmesi
    document.getElementById('sayim_kaydet_btn').addEventListener('click', function() {
        const miktar = miktarInput.value;

        if (!currentStokKod || currentStokKod === 'YOK') {
            document.getElementById('kayit_mesaji').className = 'message error';
            document.getElementById('kayit_mesaji').innerText = 'Lütfen önce geçerli bir stok bulun.';
            return;
        }
        if (parseFloat(miktar) <= 0 || isNaN(parseFloat(miktar))) {
            document.getElementById('kayit_mesaji').className = 'message error';
            document.getElementById('kayit_mesaji').innerText = 'Miktar geçerli bir sayı olmalıdır (> 0).';
            return;
        }

        const data = {
            stok_kod: currentStokKod,
            parti_no: currentPartiNo,
            renk: currentRenk,
            miktar: miktar,
            depo_kod: DEPO_KODU,
            personel_adi: PERSONEL_ADI 
        };

        fetch(`/ajax/kaydet/${SAYIM_EMRI_ID}/`, {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': CSRF_TOKEN, 
            },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('kayit_mesaji').className = 'message success';
                document.getElementById('kayit_mesaji').innerText = data.message;
                document.getElementById('yeni_toplam_goster').innerText = data.yeni_miktar;
                miktarInput.value = ''; 
            } else {
                document.getElementById('kayit_mesaji').className = 'message error';
                document.getElementById('kayit_mesaji').innerText = data.message;
            }
        })
        .catch(error => {
            document.getElementById('kayit_mesaji').className = 'message error';
            document.getElementById('kayit_mesaji').innerText = `Kritik Kayıt Hatası: Sunucuya ulaşılamadı. ${error.message}`;
        });
    });

    // Sayfa tamamen yüklendiğinde tüm olay dinleyicilerini kur ve ilk aramayı yap
    document.addEventListener('DOMContentLoaded', () => {
        setupGeminiListeners();
        setupQuickScanListener(); 
        
        setupAutoSearchListeners();
        
        akilliStokAra('YOK', 'YOK', 'YOK', 'YOK', DEPO_KODU, 'YOK');
    });
</script>
</body>
</html>